# Мотивация
В данный момент мы имеем проблемы с долгим выполнением заказов и потерей заказов.

При этом у нас нет инструмента, который позволил бы детально проанализировать проблему.

Таким инструментом является подсистема логирования.

Данная подсистема позволит нам накопить достаточное количество информации чтобы локализовать причины проблем в той или иной подсистеме.

## Влияние внедрения логирования на метрики

1. Процент успешно обработанных заказов
2. Процент заказов завершившихся ошибкой
3. Процент "потерянных" заказов - созданных, но не дошедших до финального статуса
4. Стоимость сопровождения - сокращение затрат на анализ инцидентов и устранение дефектов решения

# Предлагаемое решение

Для реализации логирования будет использоваться стек ELK (см документ ./jewerly_c4_model_log_ashmakov.drawio).

Решение по логированию будет состоять из нескольких уровней:
1) Сбор логов ОС и процессов с серверов
2) Сбор логов о бизнес событиях (создана новая заявка, изменение статусов и тп)

## Логируемая информация на уровне INFO:
1) ID сущности (клиента, заказа)
2) Тип сущности (клиент, заказ)
3) Новый статус заказа (в случае событий изменения статуса заказа)
4) Подсистема-источник события
5) Код события
6) Название события 
7) Дата и время события
8) ID записи в логе


## Ключевые требования к бизнес событиям:
1. Каждая запись лога о бизнес событии должна содержать уникальный в рамках всей системы идентификатор бизнес объекта (номер заказа, id клиента и т.п.)
2. Каждое бизнес событие должно иметь уникальный код
3. Каждое бизнес событие должно иметь флаг - является оно ошибкой или нет

## Технический стек
Для реализации подсистемы логирование будет использоваться классический стек ELK:
- ElasticSearch (хранение)
- Logstash (сбор)
- Kibana (отображение)

## Ключевые требования к реализации
1. Системные и бизнес логи хранятся отдельно
2. Логи от каждой подсистемы / сервера должны храниться в разных индексах
3. Должен быть настроен UI для поиска по ключевым полям каждого индекса
4. Должна быть настроена ротация логов: логи старше месяца должны переезжать в архивное хранилище, где они будут храниться в течении года и стираться

## Ключевые требования к реализации в части безопасности

1. Должна быть реализована авторизация и аутентификация при входе в UI логирования
2. API ElasticSearch должен быть закрыт от всех кроме технической учетной записи Kibana
2. Маскирование конфиденциальной информации (ФИО, телефоны клиентов, паролей, сумм и тп). Открытое использоватние только технических ID и нечуствительных бизнес данных 
3. Ведение журнала аудита действий пользователя в UI логирования

# Компромиссы
Ввиду стоимости работ, не предполагается глубокая доработка логирования в CRM и MES.
Для принятия решения о доработке необходимо проанализировать текущую реализацию логирования бизнес событий в данных подсистемах и принять решение.
Учитывать наличие "полной" реализации логирования на всех подсистемах API, - это сокращает задачу.
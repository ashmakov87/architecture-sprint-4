# Мотивация
В данный момент мы имеем проблемы о которых нам сообщают бизнес пользователи.

При этом у нас нет инструмента, который подсветил бы узкие места в системе и помог бы заранее спрогнозировать проблемы.

Таким инструментом является подсистема мониторинга.

Основные функции мониторинга:

1. Отображение ключевых метрик каждой подсистемы
2. Определение тенденций, прогнозирование потенциальных проблем
3. Уведомление сотрудников технической поддержки в случае превышения критических порогов метрик

Данный функционал позволит нам:
1. Больше понимать как бизнес пользователи предпочитают использовать систему, откроет ценные бизнес инсайты
2. Позволит пересмотреть сайзинг подсистем. Вертикальное масштабирование - один из быстрых способов решить проблемы с производительностью
3. Позволит действовать проактивно - не дожидаться жалоб бизнес пользователей, а предвидеть надвигающиеся проблемы

# Выбор подхода к мониторингу

## Утилизация ресурсов
Все сервера нашего решения, независимо от их назначения, должны быть поставлены на мониторинг утилизации аппаратных ресурсов: CPU, RAM, HDD.
Сбор данных метрик нужен для анализа достаточности ресурсов и выявления узких мест в системе.

Для отображения метрик будет реализован дашборд отображающий топологию нашего решения, на котором каждая подсистема будет иметь светофорный индикатор, вычисляющийся на основании данных метрик.

Ярлыки не нужны, т.к. для каждого сервера будут отдельные метрики, а большая детализация нас не интересует.

## Мониторинг подсистем, работающих с запросами
Все сервисы API (MES API, Shop API, CRM API), БД и MQ будем мониторить используя подход RED:

1. RPS - количество запросов в секунду (обращений к API / к БД / новых сообщений в MQ)
2. Количество ошибок - ошибок от API/БД, глубина ошибочных очередей MQ
3. Среднее время обработки запросов в API / выполнения запросов в БД / жизни сообщения в MQ
4. Количество активных сессий

Для данных метрик необходимы следующие ярлыки:
- Метод API / название очереди / название таблицы
- Клиент

Для каждой подсистемы - отдельный дашборд.

## Мониторинг БД
Для всех БД:

1. Количество соединений
2. Размер БД


## Бизнес метрики
Для целей развития бизнеса можно ввести дополнительные бизнес метрики. Точный список необходимо проработать с Продакт менеджером. Метрик придумано очень много, нужно совместно выбрать необходимые нам.

Примеры:

1. Conversion rate. Количество успешно завершенных заказов
2. Cost Per Sale. Средняя сумма одной сделки
3. Customer lifetime value. Средний доход с одного клиента
4. DAU/MAU. Количество уникальных пользователей в день / месяц
5. New Users. Количество новых пользователей (например, за месяц)
6. Среднее время выполнения заказа

Дашборды и отчеты необходимо прорабатывать совместно с будущими пользователями.

# План действий

- Развернуть инстанс time-series БД (Prometeus / Victoria)
- На всех серверах развернуть экспортеры метрик утилизации ресурсов
- Развернуть экспортеры метрик обработки запросов и бизнес метрик
- Развернуть средство визуализации метрик (Grafana)
- Совместно с пользователями дашбордов (продакт менеджер, сотрудники поддержки) реализовать дашборды, сформировать список триггеров для отправки оповещений
- Протестировать работоспособность подсистемы мониторинга на тестовой среде (например, гоняя нагрузочные и функциональные тесты и анализируя происходящее на дашбордах), исправить дефекты, по необходимости доработать список метрик
- Внедрить подсистему мониторинга в пром